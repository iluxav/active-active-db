syntax = "proto3";

package replication.v1;

// Inter-replica replication service for delta synchronization
service ReplicationService {
  // Bidirectional streaming for continuous delta exchange
  // Each replica maintains a persistent connection to its peers
  rpc SyncStream(stream ReplicationMessage) returns (stream ReplicationMessage);

  // One-shot anti-entropy: request full state from a peer
  // Used for initial sync or after extended partitions
  rpc AntiEntropy(AntiEntropyRequest) returns (stream Delta);

  // Join request for gossip-based peer discovery
  // New nodes call this on seed nodes to get the current peer list
  rpc Join(JoinRequest) returns (JoinResponse);
}

// Wrapper for all messages in the bidirectional stream
message ReplicationMessage {
  oneof message {
    // Initial handshake on connection establishment
    Handshake handshake = 1;
    // Batch of deltas to apply
    DeltaBatch delta_batch = 2;
    // Acknowledgment of received deltas
    Ack ack = 3;
    // Gossip message for peer discovery
    GossipMessage gossip = 4;
  }
}

// Handshake message sent when connection is established
message Handshake {
  // The sending replica's stable ID
  string replica_id = 1;
  // Protocol version for compatibility checking
  uint32 protocol_version = 2;
}

// Type of delta operation
enum DeltaType {
  // Positive (increment) counter delta - default for backwards compatibility
  DELTA_TYPE_P = 0;
  // Negative (decrement) counter delta
  DELTA_TYPE_N = 1;
  // String value delta (LWW-Register)
  DELTA_TYPE_S = 2;
}

// A single delta representing one component update
message Delta {
  // The counter key
  string key = 1;
  // The replica that originated this update
  string origin_replica_id = 2;
  // The current component value for this replica (for P/N deltas)
  uint64 component_value = 3;
  // Optional expiration timestamp in milliseconds since Unix epoch
  // Uses MAX merge semantics: later expiration always wins
  // 0 means no expiration (for backwards compatibility with proto3)
  optional uint64 expires_at_ms = 4;
  // Type of delta (P, N, or S)
  DeltaType delta_type = 5;
  // String value (for S deltas only)
  optional string string_value = 6;
  // Timestamp for LWW ordering (for S deltas only, milliseconds since epoch)
  optional uint64 timestamp_ms = 7;
  // Creation timestamp in milliseconds since Unix epoch (for latency measurement)
  uint64 created_at_ms = 8;
}

// A batch of deltas with a sequence number
message DeltaBatch {
  // Monotonically increasing sequence number
  // Used for ordering and deduplication
  uint64 sequence = 1;
  // The deltas in this batch (may be compacted)
  repeated Delta deltas = 2;
}

// Acknowledgment message
message Ack {
  // Acknowledges receipt of all batches up to and including this sequence
  uint64 sequence = 1;
}

// Request for anti-entropy full state sync
message AntiEntropyRequest {
  // The requesting replica's ID
  string replica_id = 1;
}

// ============================================================
// Gossip Protocol Messages for Peer Discovery
// ============================================================

// State of a peer in the gossip protocol
enum PeerState {
  PEER_STATE_UNKNOWN = 0;
  PEER_STATE_ALIVE = 1;
  PEER_STATE_SUSPECT = 2;
  PEER_STATE_DEAD = 3;
}

// Information about a peer in the cluster
message PeerInfo {
  // The peer's stable replica ID
  string replica_id = 1;
  // The peer's replication address (e.g., "http://10.0.0.1:9001")
  string replication_addr = 2;
  // Incarnation number - monotonically increasing, bumped on restart
  // Used to distinguish between old and new information about the same peer
  uint64 incarnation = 3;
  // Current state of this peer
  PeerState state = 4;
  // Timestamp when this peer was last seen alive (milliseconds since epoch)
  uint64 last_seen_ms = 5;
}

// Wrapper for gossip messages
message GossipMessage {
  oneof message {
    // Full peer list exchange
    PeerListSync peer_list = 1;
    // Heartbeat for failure detection
    Heartbeat heartbeat = 2;
    // Announcement that a peer is dead
    DeadAnnouncement dead = 3;
  }
}

// Full peer list exchange - sent during handshake and periodically
message PeerListSync {
  // Sender's replica ID
  string from_replica_id = 1;
  // All known peers including sender
  repeated PeerInfo peers = 2;
}

// Lightweight heartbeat for failure detection
message Heartbeat {
  // Sender's replica ID
  string replica_id = 1;
  // Sender's current incarnation number
  uint64 incarnation = 2;
  // Timestamp when heartbeat was sent (milliseconds since epoch)
  uint64 timestamp_ms = 3;
}

// Announcement that a peer has been detected as dead
message DeadAnnouncement {
  // The replica ID of the dead peer
  string dead_replica_id = 1;
  // The replica ID that detected the failure
  string announced_by = 2;
  // Timestamp of the announcement (milliseconds since epoch)
  uint64 timestamp_ms = 3;
}

// Request to join the cluster (sent to seed nodes)
message JoinRequest {
  // The joining replica's ID
  string replica_id = 1;
  // The joining replica's replication address
  string replication_addr = 2;
  // The joining replica's incarnation number
  uint64 incarnation = 3;
}

// Response to a join request
message JoinResponse {
  // Whether the join was accepted
  bool accepted = 1;
  // Current list of peers in the cluster
  repeated PeerInfo peers = 2;
}
